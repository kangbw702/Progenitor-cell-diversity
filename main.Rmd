---
title: "Single cell profiling of cortical progenitor cell diversity"
author: "bowei kang"
date: "8/19/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r,message=F}
library(dplyr)
library(Seurat)
library(ggplot2)
library(RColorBrewer)
library(tidyr)
library(patchwork)
library(tidyverse)
library(ggsci)
library(gridExtra)
library(AnnotationHub)
library(viridis)
```

```{r}
source("func.R")
```

# Full raw data analysis

read in Seurat object (after QC, clustering, and dim reduction)

```{r}
dat = readRDS("/Users/kangbowei/Dropbox/SingleCell/rds/new_merge/batch1_2_500gene_0.1mito_16dim.rds")
dat[['X19clusters']] <- dat[['seurat_clusters']] # make a copy of current idents
```

## dim reduction plot

Fig-1A and 1B: tsne plot by cluster and by day

```{r}
df1 = data.frame(cluster=dat@meta.data[["seurat_clusters"]], day=dat@meta.data[["orig.ident"]], dat@reductions$tsne@cell.embeddings)
centers=df1 %>% group_by(cluster) %>% dplyr::summarise(tsne1.c=mean(tSNE_1),tsne2.c=mean(tSNE_2))
p1 = dimred_plot(df1, ed.names=c('tSNE_1','tSNE_2'), group.by = 'cluster', centers=centers, legend.ncol=2)
p2 = dimred_plot(df1, ed.names=c('tSNE_1','tSNE_2'), group.by = 'day', label=F, palette=T)
p1
p2
```

get colors 

```{r}
g1 = ggplot_build(p1)
g2 = ggplot_build(p2)
color_seurat = g1$data[[1]] %>% group_by(group) %>% dplyr::summarise(cols = dplyr::first(colour))
color_stages = g2$data[[1]] %>% group_by(group) %>% dplyr::summarise(cols = dplyr::first(colour))
```

Fig-2A(1): tsne plot highlighting E10.5 cells

```{r}
df1 = df1 %>% mutate(flag_e10=ifelse(day%in%c('E10'),day,'Other_days'))
p3 = dimred_plot(df1, ed.names=c('tSNE_1','tSNE_2'), group.by = 'flag_e10', label=F) + scale_color_manual(values=c(color_stages$cols[1],'gray70'))
p3
```

Fig-S1C: replicate E14 (batch effect check)

```{r}
cname_list <- strsplit(colnames(dat), split = "_")
cname_mat=t(data.frame(cname_list))
# table(cname_mat[,1], cname_mat[,2])
cname_14_1 = rownames(cname_mat[cname_mat[,1]=='E14' & cname_mat[,2]==1,])
cname_14_2 = rownames(cname_mat[cname_mat[,2]=='2.1' | cname_mat[,2]=='2.2',])
df1$cname = colnames(dat)
df1$cname1 = cname_mat[,1]
df1$cname2 = cname_mat[,2]
df1 = df1 %>% mutate(replicate=factor(ifelse(cname1=='E14' & cname2==1,1,ifelse(cname2=='2.1',2,ifelse(cname2=='2.2',3,4))),labels=c('B1','S3','S7','Others')))
p4 = dimred_plot(df1, ed.names=c('tSNE_1','tSNE_2'), group.by = 'replicate', label=F) + scale_color_manual(values=c('red','blue','green2','gray75'))
p4
```

Feature plot in Fig-1D, Fig-2A,B,E, Fig-3B, Fig-S1D, Fig-S2A, Fig-S3A

```{r}
# for example
gname = 'Eomes'
df2=df1[,c('tSNE_1', 'tSNE_2')]
df2[gname] = dat@assays$RNA@data[gname,]
feature_plot(df2, gname, c('tSNE_1','tSNE_2'))
```


```{r}
# Fig1D 
gene_list=c('Hmga2','Pax6','Eomes','Stmn2','Neurod6','Dlx1','Reln','Bcl11b','Satb2')
df2=df1[,c('tSNE_1', 'tSNE_2')]
for (i in 1:length(gene_list)) {
df2[gene_list[i]] = dat@assays$RNA@data[gene_list[i],]
print(feature_plot(df2, gene_list[i], c('tSNE_1','tSNE_2')))
}
```


Fig-1C: stack violin plot

```{r}
glist = c('Neurod1', 'Id4', 'Bcl11b', 'Top2a','Neurog2','Satb2', 'Hmga2', 'Eomes','Dlx1','Crym','Ube2c', 'Nin', 'Olig1','Reln', 'Wnt8b', 'Col3a1','Cldn5','Tyrobp','Rgs5')
ordering = c(14,6,3,10,1,7,4,0,5,2,11,9,13,8,12,15,18,17,16)+1
df.v1 = data.frame(clsuter=paste0('c',0:(length(ordering)-1)), marker=glist, ident=factor(0:(length(ordering)-1)), ident.new=order(ordering)-1)

df.v2 = data.frame(ident=dat@active.ident, newid=dat@active.ident) %>% left_join(df.v1[,c(3,4)], by='ident')
# newid=factor(df.tmp3$ident.new,labels=hmap[["colInd"]]-1)
newid=factor(df.v2$ident.new,labels=ordering-1)
names(newid)=colnames(dat)
dat[['idnew']] = newid
stacked_vln_plot(obj = dat, features = glist[ordering])
```

Fig-1E: regress out cell-cycle genes (ccg) then apply PAGA to obtain FA embedding

read in Seurat object and FA embedding:

```{r}
dat.ccg = readRDS("/Users/kangbowei/Dropbox/SingleCell/rds/new_merge/batch1_2_2000_16_sctrans.rds")
dat.ccg[['X19clusters']] <- dat.ccg[['seurat_clusters']]
fa_paga = read.csv('/Users/kangbowei/Dropbox/SingleCell/rds/new_merge/fa_embedding_2000_sctrans.csv', header = F)
dat.ccg[['fa1']] = fa_paga[,1]
dat.ccg[['fa2']] = fa_paga[,2]
```

FA plot colored by original Seurat clusters: 

```{r}
df.ccg = data.frame(orig_cluster=dat.ccg@meta.data[["X19clusters"]], day=dat.ccg@meta.data[["orig.ident"]], dat.ccg[['fa1']], dat.ccg[['fa2']])
centers.ccg = df.ccg %>% group_by(orig_cluster) %>% dplyr::summarise(fa1.c=mean(fa1), fa2.c=mean(fa2))
p.ccg = dimred_plot(df.ccg, c('fa1','fa2'), group.by='orig_cluster', pt.size=0.3, legend.ncol=2, label=F) 
p.ccg = p.ccg + annotate("text", x=centers.ccg$fa1.c, y=centers.ccg$fa2.c, label=0:18, check_overlap=F, size=4)
p.ccg
```

Fig-1G: pseudotime generated by Slingshot

take subset (c8, c15-18 are filtered out) and re-cluster

```{r}
dat.ccg.1 = subset(dat.ccg, subset=X19clusters %in% c(0:7,9:14))
# dim(dat.ccg.1) # 16,649 x 9575
dat.ccg.1 = FindNeighbors(dat.ccg.1, dims = 1:30)
dat.ccg.1 = FindClusters(dat.ccg.1, resolution=0.8)
# nlevels(dat.ccg.1@active.ident)
```

further exclude new c14

```{r}
dat.ccg.1 = subset(dat.ccg.1, subset=seurat_clusters %in% c(0:13))
# table(dat.ccg.1[['seurat_clusters']])
```

Do Slingshot on new clustering by assigning new c12 as root

```{r}
cl_fa <- dat.ccg.1@meta.data[["seurat_clusters"]]
rd_fa <- cbind(dat.ccg.1[['fa1']], dat.ccg.1[['fa2']])
cl_fa_num <- as.numeric(levels(cl_fa))[cl_fa]
sds <- slingshot(rd_fa, cl_fa, start.clus = 12, extend='y')
```

plot pseudotime and principle curves

```{r}
# average pseudotime on first 4 curves
colors <- colorRampPalette(brewer.pal(20,'Spectral')[-6])(200)
pdt_agg1 = apply(slingPseudotime(sds)[,c(1,2,3,4)],1,function(t) mean(t, na.rm=T))
plotcol1 <- colors[cut(pdt_agg1, breaks=200)]
plot(reducedDims(sds), col = plotcol1, pch=16, asp = 1, cex=0.4)
lines(SlingshotDataSet(sds)@curves$curve1, lwd=3, col='black')
lines(SlingshotDataSet(sds)@curves$curve2, lwd=3, col='black')
lines(SlingshotDataSet(sds)@curves$curve3, lwd=3, col='black')
lines(SlingshotDataSet(sds)@curves$curve4, lwd=3, col='black')
```


Fig-1F: velocity plot

Fig-S1A: pie chart

```{r}
# two_way_summ_tbl(df1, c(1,3,10))
pie_plot(df1)
```

Fig-S1B: bar chart

```{r}
bar_plot(df1, "stack")
bar_plot(df1, "fill")
```

# NEC and RGC analysis

Fig-2F: Expression of NEC- and RGC-enriched genes in apical progenitors across different developmental stages

```{r}
dat.c13106 = subset(dat, subset=X19clusters%in%c(1,3,10,6))
gene.c13106.pos = c('Hmga2','Mest','Crabp2','Dlk1','Meg3','Ccnd1','Igf2bp1','Rpl26','Lrrn1','Fndc3c1')
gene.c13106.neg = c('Ptn','Aldoc','Fabp7','Nfib','Tcf4','Epha5','Nfix','Ttyh1','2610203C20Rik','Hes5')
line_plot(dat.c13106, gene.c13106.pos)
line_plot(dat.c13106, gene.c13106.neg)
```

Fig-3C, Fig-S3B

```{r}
gene.c1310.pos = c('Rpl35a','Lix1','Casp8ap2', 'Clspn', 'Id2','Gpc1', 'Gng3', 'Tubb3', 'Mat2a')
gene.c1310.neg1 = c('Dbi', 'Nfib', 'Zbtb20', 'Aldoc', 'Tcf4', 'Ndrg2', 'Nfix')
gene.c1310.neg2 = c('Bach2', 'Arrdc3', 'Id3', 'Draxin', 'Ccdc80', 'Amotl2', 'Dpysl3', 'Mfap2', 'Tsc22d4')
line_plot(dat.c13106, gene.c1310.pos)
line_plot(dat.c13106, gene.c1310.neg1)
line_plot(dat.c13106, gene.c1310.neg2)
```

Violin plots in Fig-3B and Fig-S3A

```{r}
dat.c1310 = subset(dat, subset=X19clusters%in%c(1,3,10))
dat.c1310.e1214 = subset(dat.c1310, subset=orig.ident%in%c('E12','E14'))
# VlnPlot(dat.c1310.e1214, 'Draxin',pt.size=0.2,group.by='orig.ident', cols=color_stages$cols[2:3])
vln_plot_compare(dat.c1310, 'Lix1')
```

Fig-3A

```{r}
# find marker genes E12 vs E14 for cluster 1, 3, 10, respectively
c01.mkr = find_marker_12vs14(dat,  1)
c03.mkr = find_marker_12vs14(dat,  3)
c10.mkr = find_marker_12vs14(dat, 10)

# plot
df.1310mkr=c1.mkr[,c(1,3)] %>% full_join(c3.mkr[,c(1,3)],by='X') %>% full_join(c10.mkr[,c(1,3)],by='X')
colnames(df.1310mkr)=c('X','c1','c3','c10')
df.1310mkr=df.1310mkr %>% arrange(c1,c3,c10) %>% gather('cluster','logFC',2:4)

gene_list = c('Nfix','Ndrg2','Tcf4','Aldoc','Zbtb20','Nfib','Dbi','Tsc22d4','Mfap2','Dpysl3','Amotl2','Ccdc80','Draxin','Id3','Arrdc3','Bach2','Mat2a','Tubb3','Gng3','Gpc1','Id2','Clspn','Ccnd1','Casp8ap2','Lix1','Rpl35a','Tmsb4x')

df.1310mkr=df.1310mkr %>% dplyr::filter(X%in%gene_list)
df.1310mkr=df.1310mkr %>% mutate(X = fct_relevel(X,gene_list)) %>% mutate(cluster=fct_relevel(cluster,c('c1','c3','c10')))
                          
ggplot(df.1310mkr, aes(cluster, X,fill= logFC)) + geom_tile() +scale_fill_gradient2(na.value = "grey90")+ theme_void()+theme(axis.text.x = element_text(face="plain", color="black", size=7),axis.text.y = element_text(face="plain", color="black", size=7), legend.title=element_text(size=7),legend.text=element_text(size=7))
```


Fig-S3C

```{r}
# find marker genes c1 vs c3 (cell cycle) for stage E12, 14, 15, respectively
e12.mkr = find_marker_1vs3(dat, 'E12')
e14.mkr = find_marker_1vs3(dat, 'E14')
e15.mkr = find_marker_1vs3(dat, 'E15')

# plot
df.mkr = e14.mkr[,c(1,3)] %>% left_join(e12.mkr[,c(1,3)],by='X') %>% left_join(e15.mkr[,c(1,3)],by='X')
colnames(df.mkr) = c('X','e14','e12','e15')
df.mkr = df.mkr %>% arrange(e14,e12,e15)
gene_list = df.mkr$X
df.mkr = df.mkr %>% gather('cluster','logFC',2:5)

df.mkr = df.mkr %>% mutate(X = fct_relevel(X,gene_list)) %>% mutate(X = fct_relevel(X,rev)) %>% mutate(cluster=fct_relevel(cluster,c('e12','e14','e15')))
                          
ggplot(df.mkr, aes(cluster, X,fill= logFC)) + geom_tile() +scale_fill_gradient2(na.value = "grey90")+ theme_void()+theme(axis.text.x = element_text(face="plain", color="black", size=7),axis.text.y = element_text(face="plain", color="black", size=7), legend.title=element_text(size=7),legend.text=element_text(size=7))
```

# IPC analysis

Fig-4A

```{r}
dat_Eomes_plus = get_Eomes_plus_subset(dat)

# data frame to plot
df.Eomes = data.frame(cluster=dat_Eomes_plus@meta.data[["seurat_clusters"]], day=dat_Eomes_plus@meta.data[["orig.ident"]], dat_Eomes_plus@reductions$tsne@cell.embeddings)
centers.Eomes = df.Eomes %>% group_by(cluster) %>% dplyr::summarise(tsne1.c=mean(tSNE_1),tsne2.c=mean(tSNE_2))

# dim reduction plot by new clusters
p1.Eomes = dimred_plot(df.Eomes, ed.names=c('tSNE_1','tSNE_2'), group.by='cluster', pt.size=0.8, centers=centers.Eomes, label.size=7) 
p1.Eomes = p1.Eomes + labs(color = "Clusters")+ scale_color_igv() 
p1.Eomes

# dim reduction plot by stages
p2.Eomes = dimred_plot(df.Eomes, ed.names=c('tSNE_1','tSNE_2'), group.by='day', pt.size=0.8, label=F) 
p2.Eomes = p2.Eomes + labs(color='Days') + scale_color_jama()  
p2.Eomes

# get colors of new clusters
g = ggplot_build(p1.Eomes)
color_seurat_sub = g$data[[1]] %>% group_by(group) %>% dplyr::summarise(cols = dplyr::first(colour))

# map back to original tSNE plot
cells.sub = list()
for (i in 0:(length(levels(dat_Eomes_plus@active.ident))-1)){
cells.sub[[i+1]] = colnames(subset(dat_Eomes_plus, subset=seurat_clusters==i))
}
# sapply(cells.sub, length)
dat[['Eomes_plus_flag']] = as.factor(ifelse(colnames(dat) %in% cells.sub[[1]], 0, ifelse(colnames(dat) %in% cells.sub[[2]], 1, ifelse(colnames(dat) %in% cells.sub[[3]], 2, ifelse(colnames(dat) %in% cells.sub[[4]], 3, ifelse(colnames(dat) %in% cells.sub[[5]], 4, ifelse(colnames(dat) %in% cells.sub[[6]], 5, ifelse(colnames(dat) %in% cells.sub[[7]], 6, ifelse(colnames(dat) %in% cells.sub[[8]], 7, 99)))))))))

# data frame to plot
df1 = df1 %>% mutate(Eomes_plus=dat@meta.data$Eomes_plus_flag)
p3.Eomes = dimred_plot(df1, ed.names=c('tSNE_1','tSNE_2'), group.by='Eomes_plus', pt.size=0.3, label=F)
p3.Eomes = p3.Eomes + scale_color_manual(values=c(color_seurat_sub$cols[1:8],'gray80'))
p3.Eomes
```

Fig-4B: bubble plot

```{r, fig.height=3, fig.width=6}
genes_bubble = c('Ezr', 'Abracl', 'Sstr2', 'Reln', 'Lhx5', 'Ebf2', 'Lin28b', 'Nhlh2', 'Tbr1', 'Bcl11b', 'Crmp1', 'Gng3', 'Nsg2', 'Unc5d', 'Meis2', 'Sox4', 'Pou3f3', 'Foxp4', 'Pcp4', 'Nr4a3', 'Bhlhe22', 'Zbtb20', 'Neurog2', 'Eomes','Neurod1')
bubble_plot(df=df.Eomes['cluster'], dat=dat_Eomes_plus, genes=genes_bubble, clusters=c(1,3,5,6,7), lab.display=c('c3','c7','c1','c5','c6'))
```

Fig-4B: pie charts for each sub-cluster 

```{r}
for (i in 1:length(unique(df.Eomes$cluster))){
p = pie_plot(df.Eomes[df.Eomes$cluster==(i-1),]) + ggtitle(paste0('sub-c', i-1))
print(p)
}
```

Fig-S4D: scatter plots, co-expression with Eomes

```{r}
gene_list = c('Ezr', 'Abracl', 'Sstr2', 'Reln', 'Lhx5', 'Ebf2', 'Lin28b', 'Nhlh2', 'Tbr1', 'Bcl11b', 'Crmp1', 'Gng3', 'Nsg2', 'Unc5d', 'Meis2', 'Sox4', 'Pou3f3', 'Foxp4', 'Pcp4', 'Nr4a3', 'Bhlhe22', 'Zbtb20','Neurog2', 'Eomes','Neurod1')

# create color vector
colors = color_stages %>% mutate(day=factor(group, labels=c('E10','E12','E14','E15','E16','E18')))
col_vec = colors$cols
names(col_vec) = colors$day

# prepare data frame to work on
df.scatter = df.Eomes[, c('cluster', 'day')]
for (i in 1:length(gene_list)){
df.scatter[, gene_list[i]] = dat_Eomes_plus@assays$RNA@data[gene_list[i], ]
}
df.scatter = df.scatter %>% left_join(colors,by='day') %>% dplyr::arrange(day)

# scatter plots
scatter_plot(df.scatter, 7, c("Reln","Lhx5","Ebf2","Lin28b","Nhlh2","Tbr1"))
scatter_plot(df.scatter, 1, c("Tbr1","Bcl11b","Crmp1","Gng3","Nsg2"))
scatter_plot(df.scatter, 5, c("Unc5d","Meis2","Sox4","Pou3f3","Foxp4","Pcp4"))
```


Fig-4C

```{r}
scatter_plot(df.scatter, 7, c("Lhx5","Ebf2"))
scatter_plot(df.scatter, 1, c("Bcl11b","Tbr1"))
scatter_plot(df.scatter, 5, c("Meis2","Pou3f3"))
scatter_plot(df.scatter, 6, c("Bhlhe22","Zbtb20"))
```

Fig-S4A: heat_map for Eomes+ cells

calculate cell-cycle scores:

```{r}
dat.ccg.1[['pdt']] = pdt_agg1
ref = '/Users/kangbowei/Dropbox/SingleCell/tinyatlas/cell_cycle/Homo_sapiens.csv'
dat.ccg.2 = cc_scores(dat.ccg.1, ref)
```

Apply pseudotime ordering on Eomes+ cells (Fig-4A)

```{r}
dat.ccg.2[['cellid']] = colnames(dat.ccg.2)
dat.ccg.3 = subset(dat.ccg.2, subset=cellid %in% colnames(dat_Eomes_plus)) # 1843 cells
# sum(is.na(dat.ccg.3[['pdt']]$pdt)) # 0
# table(dat.ccg.3[['X19clusters']])

# ordering cells
dat.ccg.3[['rank_pdt']] = rank(dat.ccg.3@meta.data$pdt, ties.method= "first")
# hist(dat.ccg.3@meta.data$pdt )
```

Heat-map (two panels):

```{r fig.height=1.5,fig.width=4}
gene_list = c('Neurog2','Eomes','Neurod1','Neurod6','Lhx5','Ebf2','Bhlhe22','Tbr1','Bcl11b','Zbtb20','Pou3f3','Meis2','Mki67', 'Top2a')

# prepare data frame to work on
df.pdt = data.frame(cell_id=colnames(dat.ccg.3), rank_pdt=dat.ccg.3@meta.data$rank_pdt, dat.ccg.3[['S.Score']], dat.ccg.3[['G2M.Score']])

# plot
p.ipc = heat_maps(df.pdt, dat.ccg.3, gene_list)
p.ipc[[1]]
p.ipc[[2]]
```

END








